
{% extends "myapp/base.html" %}
{% load static %}
{% block content %}

{% include 'myapp/navbar.html' %}

<link href="{% static 'css/components.css' %}" rel="stylesheet">

<script src="{% static 'js/modals.js' %}"></script>



<style>
.records-container{
    margin:2rem;
    position:relative;
    top:2rem;
}
.flex-container {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem; /* Adjust space between items */
    margin-top:2rem;
  }
  
  .flex-item {
    width: calc(50% - 1rem); /* Adjust for gap (1rem is half of 2rem) */
    border-bottom:1px solid #5EA061;
    padding:1rem;

  }

  #field_details{
    font-weight: bolder;

    font-size:1.1rem;
  }
  .container_option{
    display: flex;
    gap:1.4rem;
  }
</style>


<div class="records-container">
    <h4 style="color:#5EA061;font-weight:600;font-size:1.8rem;margin-bottom:2rem;">Pensioner List</h4>
    <div class="table-container card">
        <div class="card-body">
            <div class="table-responsive">
              <input id="myInput" type="text" placeholder="Search.." style="margin-bottom:1.2rem;float:right;">
                <table id="defaultdatatables" class="table table-bordered table-hover table-striped tables">
                  <thead class="table-success">
                  <tr>
                      <th>NAME</th>
                      <th>BANK</th>
                      <th>PTYPE</th>
                      <th>GROUPING</th>
                      <th>ACTION</th>
                  </tr>
              </thead>
              <tbody id="myTable">
                  <!-- Data will be loaded here by AJAX -->
              </tbody>
                     
                      </tbody>
                      </table>

                    </div>
                  </div>
                  
                  
                  <div id="pagination-container">
                    <div id="pagination">
                        <div id="page-numbers"></div>
                    </div>
                  </div>
                  
                  
                  </div>
                  </div>
                  

        


<!-- modal VIEW -->
<div class="modal fade" id="view_ssp_modal" tabindex="-1" aria-labelledby="view_ssp_modal" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form action="" method="post">
      {% csrf_token %}
 
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" style="font-weight:700;">PENSIONER DETAILS</h1>

        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">


        <div class="container">
        

          <div class="flex-container">

            <div class="flex-item d-flex flex-wrap">
              <span id="field_details">NAME: &nbsp;</span><h6 id="view_name" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">ID: &nbsp;</span><h6 id="view_csv_id" class="mt-1"></h6>
            </div>
            
            <div class="flex-item d-flex">
              <span id="field_details">BANK: &nbsp;</span><h6 id="view_bank" class="mt-1"></h6>
            </div>
          
            <div class="flex-item d-flex flex-wrap">
              <span id="field_details">ADDRESS1: &nbsp;</span><h6 id="view_add1" class="mt-1"></h6>
            </div>
          
            <div class="flex-item d-flex flex-wrap">
              <span id="field_details">ADDRESS2: &nbsp;</span><h6 id="view_add2" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">BIRTH: &nbsp;</span><h6 id="view_birth" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">PTYPE: &nbsp;</span><h6 id="view_ptype" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">STATUS: &nbsp;</span><h6 id="view_status" class="mt-1"></h6>
            </div>


            <div class="flex-item d-flex">
              <span id="field_details">GROUPING: &nbsp;</span><h6 id="view_grouping" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">CONMONTH: &nbsp;</span><h6 id="view_conmonth" class="mt-1"></h6>
            </div>


          </div>
          
        
        
      </div>
      

    

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
     
      </div>
    </div>
  </form>
  </div>
</div>









  <!-- modal for FAMILY TYPE -->
   <!-- modal VIEW -->
   <div class="modal fade" id="family_type_modal" tabindex="-1" aria-labelledby="family_type_modal" aria-hidden="true">
    <div class="modal-dialog">
        <form id="familyForm" method="post">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Fill Out the Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div id="ssp_name_family" style="text-align:center;margin-bottom:1.2rem;font-weight:bold;"></div>
                    <div class="mb-3">
                        <label for="endorsed_to" class="form-label">Endorsed to</label>
                        <input type="text" class="form-control" id="endorsed_to" name="endorsed_to">
                    </div>
                    <div class="mb-3">
                        <label for="relationship" class="form-label">Relationship</label>
                        <input type="text" class="form-control" id="relationship" name="relationship">
                    </div>

                    <div class="mt-3">
                      <label for="category" class="mb-2">CHECKUP TYPE</label>
                      <select id="category" name="category" class="form-control" required>
                        <option value="" disabled selected>Select a checkup type</option>
                        <option value="consultation">Consultation</option>
                        <option value="laboratory">Laboratory</option>
                        <option value="both">Both</option>
                      </select>
                    </div>


                    <input type="hidden" id="name_family" name="name">
                    <input type="hidden" id="csv_id_family" name="csv_id">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" name="save_family">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </form>
    </div>
</div>













 <!-- modal for SSP TYPE -->
   <!-- modal VIEW -->
   <div class="modal fade" id="ssp_type" tabindex="-1" aria-labelledby="ssp_type" aria-hidden="true">
    <div class="modal-dialog">
      <form action="" method="post" id="familyForm" >
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" style="font-weight:700;">SSP DETAILS</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">


    
            <div class="container">
          

              <div class="">
                <label for="name" style="margin-bottom:.4rem;margin-top:.4rem;">NAME</label>
                <input type="text" readonly class="form-control" id="name_ssp_type" name="name">
              </div>

              <div class="">
                <label for="csv_id" style="margin-bottom:.4rem;margin-top:.4rem;">ID</label>
                <input type="text" readonly class="form-control" id="csv_id_ssp_type" name="csv_id">
              </div>

              <div class="mt-3">
                <label for="category" class="mb-2">CHECKUP TYPE</label>
                <select id="category" name="category" class="form-control" required>
                  <option value="" disabled selected>Select a checkup type</option>
                  <option value="consultation">Consultation</option>
                  <option value="laboratory">Laboratory</option>
                  <option value="both">Both</option>
                </select>
              </div>
              
              

            </div>

          </div>
          <div class="modal-footer">

          <button type="submit" class="btn btn-primary" name="save_ssp">Generate Ticket</button>

            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </form>
    </div>
</div>











<script>
  $(document).ready(function() {
      fetchTickets();  // Fetch data via AJAX when the document is ready
  });
  
  function fetchTickets() {
      $.ajax({
          url: "{% url 'pensioner_lists' %}",  // Ensure this URL is correct
          type: "GET",
          dataType: "json",
          beforeSend: function() {
              $('#myTable').html('<tr class="loading"><td>Loading tickets...</td></tr>');
          },
          success: function(data) {
              console.log("Data received:", data); // Debugging line
              $('#myTable').empty();

              if (Array.isArray(data)) {
                  $.each(data, function(index, ticket) {
                      var row = $('<tr>');
                      row.append('<td>' + ticket.name + '</td>');
                      row.append('<td>' + ticket.bank + '</td>');
                      row.append('<td>' + ticket.ptype + '</td>');
                      row.append('<td>' + ticket.grouping + '</td>');
                      row.append('<td class="align-middle">' +
                          '<a style="margin-right:.4rem;" class="material-symbols-outlined btn btn-success btn_ssp_view" data-ssp-id="' + ticket.id + '">wysiwyg</a>' +
                          '<div class="dropdown d-inline-block dropend">' +
                              '<a class="btn btn-primary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Print</a>' +
                              '<ul class="dropdown-menu border-1 mt-0 shadow-sm">' +
                                  '<li><a class="dropdown-item btn_personal_checkup" data-ssp-id="' + ticket.csv_id + '">For Personal Checkup</a></li>' +
                                  '<li><a class="dropdown-item btn_family_checkup" data-ssp-id="' + ticket.csv_id + '">For Family Checkup</a></li>' +
                                  '<li><a class="dropdown-item" href="/ticket_print/' + ticket.csv_id + '/" target="_blank">View ticket</a></li>' +
                              '</ul>' +
                          '</div>' +
                      '</td>');

                      $('#myTable').append(row);
                  });

                  // Initialize pagination after data is loaded
                  initializePagination();
              } else {
                  console.error("Data is not an array:", data);
              }
          },
          error: function(jqXHR, textStatus, errorThrown) {
              console.error("Error fetching tickets:", textStatus, errorThrown);
              $('#myTable').html('<tr><td>Error fetching tickets.</td></tr>');
          }
      });
  }

  function initializePagination() {
      var rowsPerPage = 5; // Number of rows per page
      var currentPage = 1;
      var pageNumbersToShow = 5; // Number of page numbers to display at a time

      function calculateTotalPages() {
          var totalRows = $("#myTable tr").length;
          return Math.ceil(totalRows / rowsPerPage);
      }

      function showPage(page) {
          var totalPages = calculateTotalPages(); // Calculate total pages dynamically
          $("#myTable tr").hide();
          $("#myTable tr").slice((page - 1) * rowsPerPage, page * rowsPerPage).show();
          updatePageNumbers(totalPages);
          updatePaginationControls(totalPages);
      }

      function updatePaginationControls(totalPages) {
          $("#prev").prop("disabled", currentPage === 1);
          $("#next").prop("disabled", currentPage === totalPages);
      }

      function updatePageNumbers(totalPages) {
          var pageNumbersHtml = '';

          // Add first and previous controls
          pageNumbersHtml += '<button id="first">«</button> ';
          pageNumbersHtml += '<button id="prev">‹</button> ';

          // Calculate start and end page numbers
          var startPage = Math.max(1, currentPage - Math.floor(pageNumbersToShow / 2));
          var endPage = Math.min(totalPages, startPage + pageNumbersToShow - 1);

          if (endPage - startPage + 1 < pageNumbersToShow) {
              startPage = Math.max(1, endPage - pageNumbersToShow + 1);
          }

          if (startPage > 1) {
              pageNumbersHtml += '<button class="page-number" data-page="1">1</button> ';
              if (startPage > 2) {
                  pageNumbersHtml += '... ';
              }
          }

          for (var i = startPage; i <= endPage; i++) {
              pageNumbersHtml += '<button class="page-number" data-page="' + i + '">' + i + '</button> ';
          }

          if (endPage < totalPages) {
              if (endPage < totalPages - 1) {
                  pageNumbersHtml += '... ';
              }
              pageNumbersHtml += '<button class="page-number" data-page="' + totalPages + '">' + totalPages + '</button> ';
          }

          // Add next and last controls
          pageNumbersHtml += '<button id="next">›</button> ';
          pageNumbersHtml += '<button id="last">»</button>';

          $("#page-numbers").html(pageNumbersHtml);
          $(".page-number").removeClass('active');
          $(".page-number[data-page='" + currentPage + "']").addClass('active');
      }

      $("#page-numbers").on("click", ".page-number", function () {
          var page = $(this).data("page");
          currentPage = page;
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#first", function () {
          currentPage = 1;
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#last", function () {
          currentPage = calculateTotalPages(); // Calculate total pages dynamically
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#prev", function () {
          if (currentPage > 1) {
              currentPage--;
              showPage(currentPage);
          }
      });

      $("#page-numbers").on("click", "#next", function () {
          if (currentPage < calculateTotalPages()) { // Calculate total pages dynamically
              currentPage++;
              showPage(currentPage);
          }
      });

      $("#myInput").on("keyup", function () {
        var value = $(this).val().toLowerCase().trim();
        if (value === "") {
            // Reload initial data
            currentPage = 1;
            showPage(currentPage); // Display first 5 rows
        } else {
            $("#myTable tr").filter(function () {
                var rowText = $(this).text().toLowerCase().replace(/[\W_]/g, ''); // Remove special characters
                var searchText = value.replace(/[\W_]/g, ''); // Remove special characters from search term
                $(this).toggle(rowText.indexOf(searchText) > -1);
            });
        }
    });

      // Initial page setup
      showPage(currentPage);
  }
</script>






<script>

 
  function fetch_import_successful() {
    $.ajax({
        url: '{% url "fetch_add_successfully" %}',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            data.messages.forEach(function(message) {
          
                  if (message.tags.includes('added')) {
                    swal.fire({
                        title: "Record Successfully Added",
                        text: message.text,                                                                  
                        icon: 'success',          
                    });                                     
                }

               
                else {
                    swal.fire({
                        text: message.text,
                        icon: 'error',
                    });
                }
            });
        },

        error: function(error) {
            console.error('Error fetching messages:', error);
        },
        complete: function() {
            setTimeout(fetch_import_successful, 1200);
        }
    });
}

fetch_import_successful();

</script>

{%endblock content %}