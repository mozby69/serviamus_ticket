
{% extends "myapp/base.html" %}
{% load static %}
{% block content %}

{% include 'myapp/navbar.html' %}

<link href="{% static 'css/components.css' %}" rel="stylesheet">

<script src="{% static 'js/modals.js' %}"></script>

<link href="{% static 'css/aos.css'%}" rel="stylesheet">

<style>
.records-container{
    margin:2rem;
    position:relative;
    top:2rem;
}
.flex-container {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem; /* Adjust space between items */
    margin-top:2rem;
  }
  
  .flex-item {
    width: calc(50% - 1rem); /* Adjust for gap (1rem is half of 2rem) */
    border-bottom:1px solid #5EA061;
    padding:1rem;

  }

  #field_details{
    font-weight: bolder;

    font-size:1.1rem;
  }
  .container_option{
    display: flex;
    gap:1.4rem;
  }




.pagination-controls {
    margin-top: 20px;
    text-align: center;
}

.pagination-btn {
    margin: 0 5px;
    padding: 3px 8px;
    cursor: pointer;
    border:none;
}

.pagination-btn.active {
    background-color: #5EA061;
    color: white;
    border: 1px solid #5EA061;
}

.pagination-btn.disabled {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
    border: 1px solid #e9ecef;
}

.pagination-ellipsis {
    margin: 0 5px;
    color: #6c757d;
}

</style>


<div class="records-container" data-aos="fade-up" data-aos-duration="750">
  <div style="display:flex;justify-content:space-between;">
    <div><h3 style="color:#5EA061;font-weight:600;margin-bottom:2rem;">PENSIONER LIST</h3></div>
    <div><h3 style="color:#5EA061;font-weight:600;">{{ branch_name }}</h3></div>
    <div><button class="btn btn-success" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions" aria-controls="offcanvasWithBothOptions">Ticket List</button></div>
  </div>


    <div class="table-container card">
        <div class="card-body">
            <div class="table-responsive">
              <input id="myInput" type="text" placeholder="Search.." style="margin-bottom:1.2rem;float:right;">
                <table id="defaultdatatables" class="table table-bordered table-hover table-striped tables">
                  <thead class="table-success">
                  <tr>
                      <th>NAME</th>
                      <th>BANK</th>
                      <th>PTYPE</th>
                      <th>GROUPING</th>
                      <th>ACTION</th>
                  </tr>
              </thead>
              <tbody id="myTable">
                  <!-- Data will be loaded here by AJAX -->
              </tbody>
                     
                      </tbody>
                      </table>

                    </div>
                  </div>
                  
                  
                  <div id="pagination-container">
                    <div id="pagination">
                        <div id="page-numbers"></div>
                    </div>
                  </div>
                  
                  
        </div>







          
        </div>
        

        





{% comment %} modal ticket list {% endcomment %}
    <div class="offcanvas offcanvas-start" data-bs-scroll="true" tabindex="-1" id="offcanvasWithBothOptions" aria-labelledby="offcanvasWithBothOptionsLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">Ticket List</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">



        <div class="table-container card">
          <div class="card-body">
              <div class="table-responsive">
                {% comment %} <input id="myInput" type="text" placeholder="Search.." style="margin-bottom:1.2rem;float:right;"> {% endcomment %}
                  <table id="defaultdatatable2" class="table table-bordered table-hover table-striped tables" style="font-size:.7rem;">
                    <thead class="table-success" style="text-align:center;vertical-align:middle;">
                    <tr>
                        <th>NAME</th>
                        <th>DATE ISSUED</th>
                        <th>ACTION</th>
                  
                    </tr>
                </thead>
                <tbody>
                
                </tbody>
                       
                        </tbody>
                        </table>
                        <div id="pagination-controls" class="pagination-controls"></div>

                      </div>
                    </div>
                           
                    
          </div>
  

      </div>
    </div>












<!-- modal VIEW -->
<div class="modal fade" id="view_ssp_modal" tabindex="-1" aria-labelledby="view_ssp_modal" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form action="" method="post">
      {% csrf_token %}
 
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" style="font-weight:700;">PENSIONER DETAILS</h1>

        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">


        <div class="container">
        

          <div class="flex-container">

            <div class="flex-item d-flex flex-wrap">
              <span id="field_details">NAME: &nbsp;</span><h6 id="view_name" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">ID: &nbsp;</span><h6 id="view_csv_id" class="mt-1"></h6>
            </div>
            
            <div class="flex-item d-flex">
              <span id="field_details">BANK: &nbsp;</span><h6 id="view_bank" class="mt-1"></h6>
            </div>
          
            <div class="flex-item d-flex flex-wrap">
              <span id="field_details">ADDRESS1: &nbsp;</span><h6 id="view_add1" class="mt-1"></h6>
            </div>
          
            <div class="flex-item d-flex flex-wrap">
              <span id="field_details">ADDRESS2: &nbsp;</span><h6 id="view_add2" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">BIRTH: &nbsp;</span><h6 id="view_birth" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">PTYPE: &nbsp;</span><h6 id="view_ptype" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">STATUS: &nbsp;</span><h6 id="view_status" class="mt-1"></h6>
            </div>


            <div class="flex-item d-flex">
              <span id="field_details">GROUPING: &nbsp;</span><h6 id="view_grouping" class="mt-1"></h6>
            </div>

            <div class="flex-item d-flex">
              <span id="field_details">CONMONTH: &nbsp;</span><h6 id="view_conmonth" class="mt-1"></h6>
            </div>


          </div>
          
        
        
      </div>
      

    

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
     
      </div>
    </div>
  </form>
  </div>
</div>









  <!-- modal for FAMILY TYPE -->
   <!-- modal VIEW -->
   <div class="modal fade" id="family_type_modal" tabindex="-1" aria-labelledby="family_type_modal" aria-hidden="true">
    <div class="modal-dialog">
        <form id="familyForm" method="post">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Fill Out the Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div id="ssp_name_family" style="text-align:center;margin-bottom:1.2rem;font-weight:bold;"></div>
                    <div class="mb-3">
                        <label for="endorsed_to" class="form-label">Endorsed to</label>
                        <input type="text" class="form-control" id="endorsed_to" name="endorsed_to">
                    </div>
                    <div class="mb-3">
                        <label for="relationship" class="form-label">Relationship</label>
                        <input type="text" class="form-control" id="relationship" name="relationship">
                    </div>

                    <div class="mt-3">
                      <label for="category" class="mb-2">CHECKUP TYPE</label>
                      <select id="category" name="category" class="form-control" required>
                        <option value="" disabled selected>Select a checkup type</option>
                        <option value="consultation">Consultation</option>
                        <option value="laboratory">Laboratory</option>
                        <option value="both">Both</option>
                      </select>
                    </div>


                    <input type="hidden" id="name_family" name="name">
                    <input type="hidden" id="csv_id_family" name="csv_id">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" name="save_family">Save</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </form>
    </div>
</div>













 <!-- modal for SSP TYPE -->
   <!-- modal VIEW -->
   <div class="modal fade" id="ssp_type" tabindex="-1" aria-labelledby="ssp_type" aria-hidden="true">
    <div class="modal-dialog">
      <form action="" method="post" id="familyForm" >
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" style="font-weight:700;">SSP DETAILS</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">


    
            <div class="container">
          

              <div class="">
                <label for="name" style="margin-bottom:.4rem;margin-top:.4rem;">NAME</label>
                <input type="text" readonly class="form-control" id="name_ssp_type" name="name">
              </div>

              <div class="">
                <label for="csv_id" style="margin-bottom:.4rem;margin-top:.4rem;">ID</label>
                <input type="text" readonly class="form-control" id="csv_id_ssp_type" name="csv_id">
              </div>

              <div class="mt-3">
                <label for="category" class="mb-2">CHECKUP TYPE</label>
                <select id="category" name="category" class="form-control" required>
                  <option value="" disabled selected>Select a checkup type</option>
                  <option value="consultation">Consultation</option>
                  <option value="laboratory">Laboratory</option>
                  <option value="both">Both</option>
                </select>
              </div>
              
              

            </div>

          </div>
          <div class="modal-footer">

          <button type="submit" class="btn btn-primary" name="save_ssp">Generate Ticket</button>

            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </form>
    </div>
</div>














   <!-- modal VIEW canvas -->
   <div class="modal fade" id="moda_ticket_list" tabindex="-1" aria-labelledby="moda_ticket_list" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form action="" method="post" id="familyForm" >
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" style="font-weight:700;">SSP DETAILS</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">


    
            <div class="container">

              <div class="flex-container">

    


                <div class="flex-item d-flex">
                  <span id="field_details">NAME: &nbsp;</span><h6 class="view_namess mt-1"></h6>
                </div>

                <div class="flex-item d-flex">
                  <span id="field_details">ENDORSE TO: &nbsp;</span><h6 id="view_endorsed_to" class="mt-1"></h6>
                </div>
                
                <div class="flex-item d-flex">
                  <span id="field_details">RELATIONSHIP: &nbsp;</span><h6 id="view_relationship" class="mt-1"></h6>
                </div>

                <div class="flex-item d-flex">
                  <span id="field_details">DATE ISSUED: &nbsp;</span><h6 id="view_date_issued" class="mt-1"></h6>
                </div>

                <div class="flex-item d-flex">
                  <span id="field_details">VALID UNTIL: &nbsp;</span><h6 id="view_valid_until" class="mt-1"></h6>
                </div>

                <div class="flex-item d-flex">
                  <span id="field_details">CHECKUP STATUS: &nbsp;</span><h6 id="view_checkup_status" class="mt-1"></h6>
                </div>

                <div class="flex-item d-flex">
                  <span id="field_details">RECEPIENT TYPE: &nbsp;</span><h6 id="view_recepient_type" class="mt-1"></h6>
                </div>

                <div class="flex-item d-flex">
                  <span id="field_details">BRANCH NAME: &nbsp;</span><h6 id="view_counter_name" class="mt-1"></h6>
                </div>

                <div class="flex-item d-flex">
               <div id="ticket_display"></div>
                </div>

              </div>
              
              

            </div>

          </div>
          <div class="modal-footer">


            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </form>
    </div>
</div>




















   <!-- modal edit canvas -->
   <div class="modal fade" id="modal_ticket_edit_list" tabindex="-1" aria-labelledby="modal_ticket_edit_list" aria-hidden="true">
    <div class="modal-dialog">
      <form action="" method="post" class="update_ssp_modal" >
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" style="font-weight:700;">EDIT SSP DETAILS</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">


 

    
                <div class="flex-edit d-flex" style="display:none;">
                 <input type="text" class="edit_id mt-1" name="edit_id" hidden>
                </div>

                <div class="">
                  <label for="edit_names" class="form-label" style="font-weight:bold;">NAME:</label>
                 <input type="text" class="edit_names mt-1 form-control" name="edit_names" readonly>
                </div>

                <div class="mt-3">
                  <label for="edit_endorsed_to" class="form-label" style="font-weight:bold;">ENDORSED TO:</label>
                  <input type="text" class="edit_endorsed_to form-control" name="edit_endorsed_to">
                </div>
                
                <div class="mt-3">
                  <label for="edit_relationship" class="form-label" style="font-weight:bold;">RELATIONSHIP:</label>
                 <input type="text" class="edit_relationship form-control" name="edit_relationship">
                </div>

              

             
              
              


          </div>
          <div class="modal-footer">

            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </form>
    </div>
</div>



<script src="{% static 'js/aos.js' %}"></script>
<script>
    AOS.init();

  </script>

<script>
  var offcanvas = document.getElementById('offcanvasWithBothOptions');
  offcanvas.style.width = '550px';
</script>


<script>

  function display_realtime(page = 1) {
    $.ajax({
        url: '{% url "table_modal" %}',
        type: 'GET',
        dataType: 'json',
        data: { page: page },  // Pass the page number as a query parameter
        success: function (data) {
            var tableBody = $('#defaultdatatable2 tbody');
            tableBody.empty(); // Clear existing table data

            // Populate table rows with data
            data.attendances.forEach(function (attendance) {
                var row = $('<tr>');
                row.append('<td>' + (attendance.name || '') + '</td>');
                row.append('<td>' + formatDate(attendance.date_issued || '') + '</td>');
                row.append('<td>' +
                  '<a style="margin-right:.4rem;" class="material-symbols-outlined btn btn-success btn_table_modal_ticket" ' +
                  'data-table-modal-id="' + attendance.id + '" ' +
                  'data-ticket-ssp-consult="' + (attendance.ticket_ssp_consult || '') + '" ' +
                  'data-ticket-ssp-lab="' + (attendance.ticket_ssp_lab || '') + '" ' +
                  'data-ticket-family-consult="' + (attendance.ticket_family_consult || '') + '" ' +
                  'data-ticket-family-lab="' + (attendance.ticket_family_lab || '') + '">' +
                  'wysiwyg</a>' +
                  '<a style="margin-right:.4rem;" class="material-symbols-outlined btn btn-primary btn_table_modal_edit" data-table-modal-id="' + attendance.id + '">edit_square</a>' +
                  '</td>');
              
                
                
                tableBody.append(row);
            });

            // Update pagination controls
            updatePaginationControls(data);
        },
        error: function (error) {
            console.error('Error fetching attendance data:', error);
        }
    });
}

function updatePaginationControls(data) {
    var paginationControls = $('#pagination-controls');
    paginationControls.empty(); // Clear existing pagination controls

    // Add 'First' and 'Previous' buttons
    if (data.has_previous) {
        paginationControls.append('<button class="pagination-btn" onclick="display_realtime(1)">«</button>');
        paginationControls.append('<button class="pagination-btn" onclick="display_realtime(' + (data.page_number - 1) + ')">‹</button>');
    } else {
        paginationControls.append('<button class="pagination-btn disabled">«</button>');
        paginationControls.append('<button class="pagination-btn disabled">‹</button>');
    }

    // Page numbers
    data.page_range.forEach(function(page) {
        if (page === data.page_number) {
            paginationControls.append('<button class="pagination-btn active">' + page + '</button>');
        } else if (page === '...') {
            paginationControls.append('<span class="pagination-ellipsis">...</span>');
        } else {
            paginationControls.append('<button class="pagination-btn" onclick="display_realtime(' + page + ')">' + page + '</button>');
        }
    });

    // Add 'Next' and 'Last' buttons
    if (data.has_next) {
        paginationControls.append('<button class="pagination-btn" onclick="display_realtime(' + (data.page_number + 1) + ')">›</button>');
        paginationControls.append('<button class="pagination-btn" onclick="display_realtime(' + data.num_pages + ')">»</button>');
    } else {
        paginationControls.append('<button class="pagination-btn disabled">›</button>');
        paginationControls.append('<button class="pagination-btn disabled">»</button>');
    }
}


display_realtime();

// setInterval(display_realtime, 800); 

function formatDate(dateStr) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', options);
}
</script>




<script>
  $(document).ready(function() {
      fetchTickets();  // Fetch data via AJAX when the document is ready
  });
  
  function fetchTickets() {
      $.ajax({
          url: "{% url 'pensioner_lists' %}",  // Ensure this URL is correct
          type: "GET",
          dataType: "json",
          beforeSend: function() {
              $('#myTable').html('<tr class="loading"><td>Loading tickets...</td></tr>');
          },
          success: function(data) {
              console.log("Data received:", data); // Debugging line
              $('#myTable').empty();

              if (Array.isArray(data)) {
                  $.each(data, function(index, ticket) {
                      var row = $('<tr>');
                      row.append('<td>' + ticket.name + '</td>');
                      row.append('<td>' + ticket.bank + '</td>');
                      row.append('<td>' + ticket.ptype + '</td>');
                      row.append('<td>' + ticket.grouping + '</td>');
                      row.append('<td class="align-middle">' +
                          '<a style="margin-right:.4rem;" class="material-symbols-outlined btn btn-success btn_ssp_view" data-ssp-id="' + ticket.id + '">wysiwyg</a>' +
                          '<div class="dropdown d-inline-block dropend">' +
                              '<a class="btn btn-primary dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Add</a>' +
                              '<ul class="dropdown-menu border-1 mt-0 shadow-sm">' +
                                  '<li><a class="dropdown-item btn_personal_checkup" data-ssp-id="' + ticket.csv_id + '" data-branch-name="' + ticket.branch_name + '">For Personal Checkup</a></li>' +
                                  '<li><a class="dropdown-item btn_family_checkup" data-ssp-id="' + ticket.csv_id + '" data-branch-name="' + ticket.branch_name + '">For Family Checkup</a></li>' +
                                  '<li><a class="dropdown-item" href="/ticket_print/' + ticket.csv_id + '/" target="_blank">View ticket</a></li>' +
                              '</ul>' +
                          '</div>' +
                      '</td>');

                      $('#myTable').append(row);
                  });

                  // Initialize pagination after data is loaded
                  initializePagination();
              } else {
                  console.error("Data is not an array:", data);
              }
          },
          error: function(jqXHR, textStatus, errorThrown) {
              console.error("Error fetching tickets:", textStatus, errorThrown);
              $('#myTable').html('<tr><td>Error fetching tickets.</td></tr>');
          }
      });
  }

  function initializePagination() {
      var rowsPerPage = 5; // Number of rows per page
      var currentPage = 1;
      var pageNumbersToShow = 5; // Number of page numbers to display at a time

      function calculateTotalPages() {
          var totalRows = $("#myTable tr").length;
          return Math.ceil(totalRows / rowsPerPage);
      }

      function showPage(page) {
          var totalPages = calculateTotalPages(); // Calculate total pages dynamically
          $("#myTable tr").hide();
          $("#myTable tr").slice((page - 1) * rowsPerPage, page * rowsPerPage).show();
          updatePageNumbers(totalPages);
          updatePaginationControls(totalPages);
      }

      function updatePaginationControls(totalPages) {
          $("#prev").prop("disabled", currentPage === 1);
          $("#next").prop("disabled", currentPage === totalPages);
      }

      function updatePageNumbers(totalPages) {
          var pageNumbersHtml = '';

          // Add first and previous controls
          pageNumbersHtml += '<button id="first">«</button> ';
          pageNumbersHtml += '<button id="prev">‹</button> ';

          // Calculate start and end page numbers
          var startPage = Math.max(1, currentPage - Math.floor(pageNumbersToShow / 2));
          var endPage = Math.min(totalPages, startPage + pageNumbersToShow - 1);

          if (endPage - startPage + 1 < pageNumbersToShow) {
              startPage = Math.max(1, endPage - pageNumbersToShow + 1);
          }

          if (startPage > 1) {
              pageNumbersHtml += '<button class="page-number" data-page="1">1</button> ';
              if (startPage > 2) {
                  pageNumbersHtml += '... ';
              }
          }

          for (var i = startPage; i <= endPage; i++) {
              pageNumbersHtml += '<button class="page-number" data-page="' + i + '">' + i + '</button> ';
          }

          if (endPage < totalPages) {
              if (endPage < totalPages - 1) {
                  pageNumbersHtml += '... ';
              }
              pageNumbersHtml += '<button class="page-number" data-page="' + totalPages + '">' + totalPages + '</button> ';
          }

          // Add next and last controls
          pageNumbersHtml += '<button id="next">›</button> ';
          pageNumbersHtml += '<button id="last">»</button>';

          $("#page-numbers").html(pageNumbersHtml);
          $(".page-number").removeClass('active');
          $(".page-number[data-page='" + currentPage + "']").addClass('active');
      }

      $("#page-numbers").on("click", ".page-number", function () {
          var page = $(this).data("page");
          currentPage = page;
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#first", function () {
          currentPage = 1;
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#last", function () {
          currentPage = calculateTotalPages(); // Calculate total pages dynamically
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#prev", function () {
          if (currentPage > 1) {
              currentPage--;
              showPage(currentPage);
          }
      });

      $("#page-numbers").on("click", "#next", function () {
          if (currentPage < calculateTotalPages()) { // Calculate total pages dynamically
              currentPage++;
              showPage(currentPage);
          }
      });

      $("#myInput").on("keyup", function () {
        var value = $(this).val().toLowerCase().trim();
        if (value === "") {
            // Reload initial data
            currentPage = 1;
            showPage(currentPage); // Display first 5 rows
        } else {
            $("#myTable tr").filter(function () {
                var rowText = $(this).text().toLowerCase().replace(/[\W_]/g, ''); // Remove special characters
                var searchText = value.replace(/[\W_]/g, ''); // Remove special characters from search term
                $(this).toggle(rowText.indexOf(searchText) > -1);
            });
        }
    });

      // Initial page setup
      showPage(currentPage);
  }
</script>






<script>

 
  function fetch_import_successful() {
    $.ajax({
        url: '{% url "fetch_add_successfully" %}',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            data.messages.forEach(function(message) {
          
                  if (message.tags.includes('added')) {
                    swal.fire({
                        title: "Record Successfully Added",
                        text: message.text,                                                                  
                        icon: 'success',          
                    });                                     
                }
                else if (message.tags.includes('duplicate')) {
                  swal.fire({
                      title: "Ticket already exist",
                      text: message.text,                                                                  
                      icon: 'warning',          
                  });                                     
              }
               
                else {
                    swal.fire({
                        text: message.text,
                        icon: 'error',
                    });
                }
            });
        },

        error: function(error) {
            console.error('Error fetching messages:', error);
        },
    
    });
}

fetch_import_successful();

</script>

{%endblock content %}