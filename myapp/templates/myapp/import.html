
{% extends "myapp/base.html" %}
{% load static %}
{% block content %}

{% include 'myapp/navbar.html' %}

{% comment %} <link href="{% static 'css/components.css' %}" rel="stylesheet">
<script src="{% static 'js/components.js'%}" defer></script> {% endcomment %}

<link href="{% static 'css/import.css' %}" rel="stylesheet">

<link href="{% static 'css/aos.css'%}" rel="stylesheet">

<style>
    .pagination-controls {
        text-align: center;
        margin-top: 20px;
    }
    
    .pagination-btn {
        padding: 5px 10px;
        margin: 0 2px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
        cursor: pointer;
    }
    
    .pagination-btn.active {
        background-color: #55AF5A;
        color: white;
    }
    
    .pagination-btn.disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    .pagination-ellipsis {
        padding: 5px 10px;
        margin: 0 2px;
        color: #777;
    }
    
</style>

<div class="container">
    <div class="row">
        <div class="col-md-6" data-aos="fade-up" data-aos-duration="750">
            <h4 style="color:#5EA061;font-weight:bold;text-align:center;margin-bottom:1.2rem;">IMPORT CSV FILE</h4>
            <div class="section1">
                <div class="upload-container">
                    <div class="upload-item1">
                        {% comment %} <img src="{% static 'images/import2.png' %}" id="import_pic" alt="Import"> {% endcomment %}
                        <lottie-player 
                        src="{% static 'json/aa2.json' %}" 
                        background="transparent" 
                        speed="1.5" 
                        style="width: 300px; height: 300px" 
                        direction="1" 
                        mode="normal" 
                        loop 
                        autoplay>
                    </lottie-player>
                    
                    </div>
                    <div class="upload-item2">
                        <form method="post" enctype="multipart/form-data" class="import_form">
                            {% csrf_token %}
                            <div class="formsubmit">
                            {{ form.as_p }}
                        </div>
                        {% comment %} <input type="file"> {% endcomment %}
                        <button type="submit" class="btn btn-success">Import</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6" data-aos="fade-up" data-aos-duration="800">
            <h4 style="color:#5EA061;font-weight:bold;text-align:center;margin-bottom:1.2rem;">SUBMISSION HISTORY</h4>
            <div class="table-list">
                <div class="table-container card" style="border:1px solid #5EA061;border-radius:.8rem;">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="defaultdatatables" class="table table-bordered table-hover table-striped tables">
                                <thead class="table-success">
                                    <tr>
                                        <th>IMPORT DATE</th>
                                        <th>FILE NAME</th>
                                    </tr>
                                </thead>
                                <tbody id="myTable">
                               
               
                                </tbody>
                            </table>
                        </div>

                        <div id="pagination-controls" class="pagination-controls">
                            <!-- Pagination buttons will be inserted here dynamically via JavaScript -->
                        </div>
                    </div>

            

                    
                </div>
            </div>
        </div>

     


    </div>
</div>


<script src="{% static 'js/lottie_player.js'%}"></script> 
<script src="{% static 'js/aos.js' %}"></script>


<script>

    $(document).ready(function() {
        fetchTickets(1); // Load the first page by default
    });
    
    function fetchTickets(page) {
        $.ajax({
            url: "{% url 'ajax_import_table' %}",
            type: "GET",
            data: {
                page: page  // Pass the page number to the server
            },
            dataType: "json",
            beforeSend: function() {
                $('#myTable').html('<tr class="loading"><td colspan="2">Loading tickets...</td></tr>');
            },
            success: function(data) {
                $('#myTable').empty();
    
                // Populate table rows
                $.each(data.data, function(index, ticket) {
                    var row = $('<tr>');
                    row.append('<td>' + ticket.import_date + '</td>');
                    row.append('<td>' + ticket.file_name + '</td>');
                    $('#myTable').append(row);
                });
    
                // Update pagination controls
                updatePaginationControls(data);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error fetching tickets:", textStatus, errorThrown);
                $('#myTable').html('<tr><td colspan="2">Error fetching tickets.</td></tr>');
            }
        });
    }
    
    function updatePaginationControls(data) {
        var paginationControls = $('#pagination-controls');
        paginationControls.empty(); // Clear existing pagination controls
    
        // Add 'First' and 'Previous' buttons
        if (data.has_previous) {
            paginationControls.append('<button class="pagination-btn" onclick="fetchTickets(1)">«</button>');
            paginationControls.append('<button class="pagination-btn" onclick="fetchTickets(' + (data.page_number - 1) + ')">‹</button>');
        } else {
            paginationControls.append('<button class="pagination-btn disabled">«</button>');
            paginationControls.append('<button class="pagination-btn disabled">‹</button>');
        }
    
        // Page numbers
        data.page_range.forEach(function(page) {
            if (page === data.page_number) {
                paginationControls.append('<button class="pagination-btn active">' + page + '</button>');
            } else if (page === '...') {
                paginationControls.append('<span class="pagination-ellipsis">...</span>');
            } else {
                paginationControls.append('<button class="pagination-btn" onclick="fetchTickets(' + page + ')">' + page + '</button>');
            }
        });
    
        // Add 'Next' and 'Last' buttons
        if (data.has_next) {
            paginationControls.append('<button class="pagination-btn" onclick="fetchTickets(' + (data.page_number + 1) + ')">›</button>');
            paginationControls.append('<button class="pagination-btn" onclick="fetchTickets(' + data.num_pages + ')">»</button>');
        } else {
            paginationControls.append('<button class="pagination-btn disabled">›</button>');
            paginationControls.append('<button class="pagination-btn disabled">»</button>');
        }
    }

    

    </script>
    


<script>
    AOS.init();

  </script>

  <script>
    function fetch_import_successful() {
        $.ajax({
            url: '{% url "fetch_import_successful" %}',
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                data.messages.forEach(function(message) {
                    if (message.tags.includes('success_import')) {
                        swal.fire({
                            title: "Import Successfully",
                            text: message.text,
                            icon: 'success',
                        });
                    } else {
                        swal.fire({
                            text: message.text,
                            icon: 'error',
                        });
                    }
                });
            },
            error: function(error) {
                console.error('Error fetching messages:', error);
            }
        });
    }

    $(document).ready(function() {
        $('.import_form').on('submit', function(event) {
            event.preventDefault();

            // Perform the form submission via AJAX
            $.ajax({
                url: window.location.href,  // Submit to the current URL
                method: $(this).attr('method'),  // Get the method from the form (usually 'POST')
                data: new FormData(this),  // Use FormData to handle file uploads
                processData: false,  // Important for file uploads
                contentType: false,  // Important for file uploads
                success: function(response) {
                    // Call the function to check for successful import after the form is submitted
                    fetch_import_successful();
                },
                error: function(error) {
                    console.error('Error submitting the form:', error);
                }
            });
        });
    });
</script>



{% endblock content  %}