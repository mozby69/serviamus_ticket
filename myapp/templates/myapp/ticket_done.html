
{% extends "myapp/base.html" %}
{% load static %}
{% block content %}

{% include 'myapp/navbar.html' %}

<link href="{% static 'css/components.css' %}" rel="stylesheet">
<!-- <script src="{% static 'js/components.js'%}" defer></script> -->
<link href="{% static 'css/aos.css'%}" rel="stylesheet">
<style>
   
.records-container{
    margin:2rem;
    position:relative;
    top:2rem;
}


</style>



<div class="records-container" data-aos="fade-up" data-aos-duration="750">
    <div style="display:flex;gap:1rem;">
        <div style="position:relative;bottom:.3rem;"><img src="{% static 'images/nobg.png'%}" width="45" height="45"></div>
        <div><h4 style="color:#5EA061;font-weight:900;font-size:1.8rem;margin-bottom:2rem;">TICKET LIST</h4></div>
  
    </div>

 
    <div class="table-container card">
        <div class="card-body">
            <div class="table-responsive">
                <input id="myInput" type="text" placeholder="Search.." style="margin-bottom:1.2rem;float:right;">
                <table id="defaultdatatables" class="table table-bordered table-hover table-striped tables">
                    <thead class="table-success">
                        <tr>
                            <th>NAME</th>
                            <th>DATE ISSUED</th>
                            <th>VALID UNTIL</th>
                            <th>ENDORSED TO</th>
                            <th>RELATIONSHIP</th>
                            <th>CHECKUP TYPE</th>
                            <th>RECEPIENT TYPE</th>
                            <th>BRANCH</th>
                            <th>CHECKUP STATUS</th>
                            <th>ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="myTable">
                        <tr class="loading">
                            <td colspan="6">Loading tickets...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

             
        <div id="pagination-container">
            <div id="pagination">
                <div id="page-numbers"></div>
            </div>
          </div>

          
    </div>
</div>










<!-- Modal -->
<div class="modal fade" id="ticket_list_modal" tabindex="-1" aria-labelledby="ticket_list_modal" aria-hidden="true">
    <div class="modal-dialog">
        <form id="familyForm" method="post">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ticket Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="display_name" class="mb-3"></div>
                    <div id="ticket_display"></div>
                    <input type="hidden" id="csv_id_tick">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="save_ticket_done">Done Checkup</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </form>
    </div>
</div>


<script src="{% static 'js/aos.js' %}"></script>
<script>
    AOS.init();

  </script>
<script src="{% static 'js/modals.js' %}"></script>
<script>

    $(document).ready(function() {
        fetchTickets();
    });
    
    function fetchTickets() {
        $.ajax({
            url: "{% url 'fetch_tickets' %}",  // Ensure this URL is correct
            type: "GET",
            dataType: "json",
            beforeSend: function() {
                $('#myTable').html('<tr class="loading"><td>Loading tickets...</td></tr>');
            },
            success: function(data) {
                $('#myTable').empty();
    
                $.each(data, function(index, ticket) {
                    var badgeClass = ticket.checkup_status == 'DONE CHECKUP' ? 'badge text-bg-success' : 'badge text-bg-warning';
                    
                    var row = $('<tr>');
                    var endorsedTo = ticket.endorsed_to ? ticket.endorsed_to : ''; 
                    var fin_relationship = ticket.relationship ? ticket.relationship : '';
                    row.append('<td>' + ticket.name + '</td>');
                    row.append('<td>' + formatDate(ticket.date_issued) + '</td>');
                    row.append('<td>' + formatDate(ticket.valid_until) + '</td>');
                    row.append('<td>' + endorsedTo + '</td>');
                    row.append('<td>' +fin_relationship+ '</td>');
                    row.append('<td>' + ticket.checkup_type + '</td>');
                    row.append('<td>' + ticket.recepient_type + '</td>');
                    row.append('<td>' + ticket.branch_name + '</td>');
                    row.append("<td style='width:9.2rem;margin-left:1rem;margin-top:.6rem;padding:.8rem 1rem;' class='" + badgeClass + "'>" + ticket.checkup_status + '</td>');
                    row.append('<td><a class="material-symbols-outlined btn btn-success btn_ticket_list_done" ' +
                        'data-ssp-id="' + ticket.id + '" ' +
                        'data-ssp-name="' + ticket.name + '" ' +
                        'data-ticket-ssp-consult="' + (ticket.ticket_ssp_consult || '') + '" ' +
                        'data-ticket-ssp-lab="' + (ticket.ticket_ssp_lab || '') + '" ' +
                        'data-ticket-family-consult="' + (ticket.ticket_family_consult || '') + '" ' +
                        'data-ticket-family-lab="' + (ticket.ticket_family_lab || '') + '">' +
                        'wysiwyg</a></td>');
    
                    $('#myTable').append(row);
                    initializePagination();
                });
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.error("Error fetching tickets:", textStatus, errorThrown);
                $('#myTable').html('<tr><td>Error fetching tickets.</td></tr>');
            }
        });
    }




    function formatDate(dateStr) {
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', options);
}
</script>


<script>
      function initializePagination() {
      var rowsPerPage = 5; // Number of rows per page
      var currentPage = 1;
      var pageNumbersToShow = 5; // Number of page numbers to display at a time

      function calculateTotalPages() {
          var totalRows = $("#myTable tr").length;
          return Math.ceil(totalRows / rowsPerPage);
      }

      function showPage(page) {
          var totalPages = calculateTotalPages(); // Calculate total pages dynamically
          $("#myTable tr").hide();
          $("#myTable tr").slice((page - 1) * rowsPerPage, page * rowsPerPage).show();
          updatePageNumbers(totalPages);
          updatePaginationControls(totalPages);
      }

      function updatePaginationControls(totalPages) {
          $("#prev").prop("disabled", currentPage === 1);
          $("#next").prop("disabled", currentPage === totalPages);
      }

      function updatePageNumbers(totalPages) {
          var pageNumbersHtml = '';

          // Add first and previous controls
          pageNumbersHtml += '<button id="first">«</button> ';
          pageNumbersHtml += '<button id="prev">‹</button> ';

          // Calculate start and end page numbers
          var startPage = Math.max(1, currentPage - Math.floor(pageNumbersToShow / 2));
          var endPage = Math.min(totalPages, startPage + pageNumbersToShow - 1);

          if (endPage - startPage + 1 < pageNumbersToShow) {
              startPage = Math.max(1, endPage - pageNumbersToShow + 1);
          }

          if (startPage > 1) {
              pageNumbersHtml += '<button class="page-number" data-page="1">1</button> ';
              if (startPage > 2) {
                  pageNumbersHtml += '... ';
              }
          }

          for (var i = startPage; i <= endPage; i++) {
              pageNumbersHtml += '<button class="page-number" data-page="' + i + '">' + i + '</button> ';
          }

          if (endPage < totalPages) {
              if (endPage < totalPages - 1) {
                  pageNumbersHtml += '... ';
              }
              pageNumbersHtml += '<button class="page-number" data-page="' + totalPages + '">' + totalPages + '</button> ';
          }

          // Add next and last controls
          pageNumbersHtml += '<button id="next">›</button> ';
          pageNumbersHtml += '<button id="last">»</button>';

          $("#page-numbers").html(pageNumbersHtml);
          $(".page-number").removeClass('active');
          $(".page-number[data-page='" + currentPage + "']").addClass('active');
      }

      $("#page-numbers").on("click", ".page-number", function () {
          var page = $(this).data("page");
          currentPage = page;
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#first", function () {
          currentPage = 1;
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#last", function () {
          currentPage = calculateTotalPages(); // Calculate total pages dynamically
          showPage(currentPage);
      });

      $("#page-numbers").on("click", "#prev", function () {
          if (currentPage > 1) {
              currentPage--;
              showPage(currentPage);
          }
      });

      $("#page-numbers").on("click", "#next", function () {
          if (currentPage < calculateTotalPages()) { // Calculate total pages dynamically
              currentPage++;
              showPage(currentPage);
          }
      });

      $("#myInput").on("keyup", function () {
        var value = $(this).val().toLowerCase().trim();
        if (value === "") {
            // Reload initial data
            currentPage = 1;
            showPage(currentPage); // Display first 5 rows
        } else {
            $("#myTable tr").filter(function () {
                var rowText = $(this).text().toLowerCase().replace(/[\W_]/g, ''); // Remove special characters
                var searchText = value.replace(/[\W_]/g, ''); // Remove special characters from search term
                $(this).toggle(rowText.indexOf(searchText) > -1);
            });
        }
    });

      // Initial page setup
      showPage(currentPage);
  }
</script>
{% endblock %}